# 非线性优化

​	SLAM有运动方程和观测方程：
$$
x_k=f(x_{k-1},u_k)+w_k \\
z_{k,j}=h(y_j,x_k)+v_{k,j}
$$
​	这里 $x$ 代表了相机的位姿，可以用变换矩阵（SE(3)）描述，然后用李代数进行细节方面调整的优化。观测方程由针孔相机的模型给定，代表了在 $x_k$ 处对路标 $j_y$ 进行了依次观测，这时对应到图上的像素位置 $z_{k,j}$. 这里的内参由相机决定，外参是相机的位姿。但是上述描述都是在 noise free 的情况下讨论的，在加上 $w, v$ 这两种噪声后，我们需要讨论如何在有噪声的数据中进行准确的状态估计。

## 状态估计问题

### 批量状态估计与最大后验估计

#### 运动方程和观测方程

​	我们知道运动方程和观测方程：
$$
x_k=f(x_{k-1},u_k)+w_k \\
z_{k,j}=h(y_j,x_k)+v_{k,j}
$$

##### 参数

​		$x_k, \space x_{k-1}$：机器人的实际位置，可以用变换矩阵（SE(3)）描述，用李代数进行微调

​		$u_k$：运动传感器的读数，读出来的两个时间点上运动的变化量

​		$w_k$：运动过程中加进去的噪声

​		$z_{k,j}$：在 k 时刻，y 路标点在相机上成像的坐标

​		$y_j$：路标点 j

​		$z_{k,j}$：观测过程中的噪声

##### 相机模型

如果将观测方程写成相机模型中的形式 ，则为：
$$
zP_{uv}=K(RP_w+t)\space \space \to sz_{k,j}=K(R_ky_j+t_k)
$$
​	这里 $s$ 为像素点的距离，$z_{k,j}$ 为路标在图上的像素位置，$K$ 为相机的内参矩阵，$y_j$ 为路标点在世界坐标系下的坐标，$R_k, t_k$ 为外参（旋转，平移）。

##### 加入噪声项

​	现在我们将两个噪声项（$w_k,v_{k,j}$）加入考虑，并且假设两者符合零均值的高斯分布：
$$
w_k \sim \mathcal{N}(0,R_k), \space \space v_k\sim\mathcal{N}(0,Q_{k,j})
$$
​	这里 $\mathcal{N}$ 代表高斯分布，0 代表零均值，$R_k,Q_{k,j}$ 是协方差矩阵。

​	在这些噪声得影响下，我们希望通过带噪声的数据 $z$ 和 $u$ 来推断出机器人的位姿 $x$ 和地图 $y$（以及他们的概率分布）。这就是一个状态估计问题。

#### 状态估计问题的处理方法

##### 增量/渐进（incremental）/ 滤波器：

* 持有一个当前时刻的估计状态，然后用新的数据来更新
* 卡尔曼滤波器
* 仅关心当前时刻的状态估计 $x_k$，之前的状态不予考虑

##### 批量（batch）：

* 将数据攒起来一并处理
* 可以在更大的范围达到最优化，比如让机器人收集所有时刻的数据之后统一处理，但是这样不是实时处理

##### 滑动窗口估计法：

* 固定一些历史轨迹，仅对当前时刻附近的一些轨迹进行优化

  

#### 非线性的批量优化

​	假设在 1-N 的时刻中有 M 个路标点，那么机器人位姿和路标点可以表示为：
$$
x=\{x_1,x_2,...,x_N\} \space , \space y=\{y_1,y_2,...,y_M\}
$$
​	那么这里一直的数据为传感器输出的所有时刻的输出数据 $u$ 和所有时刻相机观测到的路标点的数据 $y$。希望求的量为机器人的实际位置 $x$ 和路标的实际位置 $y$。所以对机器人状态的估计可以简化为在一直输入数据 $u$ 和观测数据 $z$ 的条件下，求状态 $x,y$ 的条件概率分布：
$$
P(x,y|z,U)
$$
​	如果我们不知道传感器的输入数据，则估计$P(x,y|z)$，被称为sfM，从许多图像中重建三维空间结构。

##### 计算P：

$$
\underbrace{P(x,y|z,u)}_{后验概率}=\frac{P(z,u|x,y)P(x,y)}{P(z,u)}\propto \underbrace{P(z,u|x,y)}_{似然\\Likehood}\underbrace{P(x,y)}_{先验\\Prior}
$$

​	这里直接求后验分布是困难的，但是求一个状态最优估计，使得在该状态下后验概率最大化是可行的：
$$
(x,y)^*_{\text{MAP}}=\arg\max P(x,y|z,u)=\arg\max P(u,z|x,y)P(x,y)
$$
​	即求解最大后验概率等价于最大化似然和先验的乘积。

##### 求解最大似然估计（Maximize Likelihood Estimation，MLE）

​	如果我们不知道机器人和路标大概在什么地方，即 $P(x,y)$ 未知，那么我们不用考虑先验，可以求解MLE：
$$
(x,y)^*_{\text{MLE}}=\arg\max P(z,u|x,y)
$$
​	似然（Likelihood）指在现在的位姿下，可能产生怎样的观测数据。在这里我们已知的是观测数据，那么最大似然估计可以理解为：“在什么样的状态下，最可能产生现在观测到的数据。“



### 最小二乘

#### 观测模型和观测数据的条件概率：

对于某一次观测：
$$
z_{k,j}=h(y_j,x_k)+v_{k,j}
$$
加入噪声项之后，观测数据的条件概率为：
$$
P(z_{j,k}|x_k,y_j)=\mathcal N(h(y_j,x_k),Q_{k,j}
$$
这里我们用最小化负对数来求一个高斯分布的最大似然。

代入SLAM的观测模型，并且经过相关推导之后我们可以得到：
$$
(x_k,y_j)^*=\arg\max \mathcal N(h(y_j,x_k),Q_{k,j})\\=\arg\min ((z_{k,j}-h(x_k,y_j))^TQ_{k,j}^{-1}(z_{k,j}-h(x_k,y)))
$$
上面公式是针对某一个时刻的观测模型，现在我们考虑批量时刻的数据，假设各个时刻的输入和观测是相对独立的，那么各个输入见是独立的，各个观测间也是独立的。所以我们可以得到：
$$
P(z,u|x,y)=\prod_kP(u_k|x_{k-1},x_k)\prod_{k,j}P(z_{k,j}|x_k,y_j)
$$
这说明了我们可以独立处理各时刻的运动和观测。

##### 误差

我们定义各次输入和观测数据与模型之间的误差：
$$
e_{u,k}=x_k-f(x_{k-1},u_k) \\
e_{z,j,k}=z_{k,j}-h(x_k,y_j)
$$
将各个时刻的误差累积起来就得到了一个最小二乘问题：
$$
\min J(x,y)=\sum_k e_{u,k}^TR_k^{-1}e_{u,k}+\sum_k\sum_ke^{-1}_{z,k,j}Q^{-1}_{k,j}e_{z,k,j}
$$
我们需要解决的就是如何求解这个最小二乘问题



### 例子：批量状态估计

考虑有一辆汽车在沿 x 轴方向前进或后退地运动，那么运动和观测方程为：
$$
运动：\space x_k=x_{k-1}+u_k+w_k, \space\space\space\space w_k\sim\mathcal{N}(0,Q_k)\\
观测：\space z_k=x_k+n_k,\space\space\space\space\space\space\space\space\space\space\space\space\space\space\space\space\space\space n_k\sim\mathcal{N}(0,R_k)
$$
这里每一项代表：

* $x_k$：k 时刻汽车的位置
* $x_{k-1}$：k-1 时刻汽车的位置
* $u_k$：k 时刻传感器读出的与上个时刻之间的差值
* $w_k$：运动中的噪声（误差）
* $z_k$：汽车位置的测量值
* $n_k$：观测中的噪声

这里假设汽车经过了三个时刻，k=1,2,3，而且初始状态 $x_0$ 已知：
$$
x=\begin{bmatrix} x_0 \\ x_1 \\ x_2 \\ x_3\end{bmatrix}, \quad z=\begin{bmatrix}z_1\\z_2\\z_3\end{bmatrix},\quad u=\begin{bmatrix}u_1\\u_2\\u_3\end{bmatrix}
$$
根据之前的推导我们知道最大似然估计为：
$$
x^*_{\text map}=\arg\max P(x|u,z)=\arg\max P(u,z|x)=\prod_{k=1}^3P(u_k|x_{k-1},x_k)\prod_{k=1}^3P(z_k|x_k)
$$
我们从运动方程和观测方程已知：
$$
P(z_k|x_k)=\mathcal N(x_k, R_k) \\
P(u_k|x_{k-1},x_k)=\mathcal N(x_k-x_{k-1},Q_k)
$$
同样，我们构建误差变量：
$$
e_{u,k}=x_k-x_{k-1}-u_k \\
e_{z,k}=z_k-x_k
$$
整理得知，最小二乘的目标函数为：
$$
\min \sum_{k=1}^3 e_{u,k}^T Q_k^{-1} + \sum_{k=1}^3 e_{z,k}^T R_{k}^{-1} e_{z,k}
$$

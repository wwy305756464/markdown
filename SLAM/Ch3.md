# 三维空间刚体运动

C++中可以用线性代数库Eigen来帮助矩阵运算，而且它的Geometry模块提供了四元数等描述刚体运动的结构。

## 旋转矩阵

### 点、向量和坐标系

刚体有位置和自身的姿态，如果将相机当作刚体，那么位置是指相机在空间中的哪个地方，姿态指相机的朝向

#### 点和向量

空间中的基本元素，没有长度，没有体积。把两个点连接起来就构成了向量，向量可以看作是从某个点指向另一个点的一个箭头。

#### 向量 vs. 坐标

如果没有坐标系，那么向量就只是一个箭头，只有加上了坐标系，才能谈论该向量在此坐标系下的坐标。

#### 用一组基来将向量转变为坐标

这里，我们用一组基（e1，e2，e3），或者可以理解为（x，y，z）坐标轴？那么向量a的坐标就为：
$$
a=\begin{bmatrix}
    e_1 & e_2 & e_3
  \end{bmatrix} 
  \begin{bmatrix}
  	a_1 \\ a_2 \\ a_3
  \end{bmatrix} = 
  a_1e_1+a_2e_2+a_3e_3
$$
这里（a1，a2，a3）即为 a 在此基下的坐标。

#### 内积和外积

$$
内积：	a \cdot b=a^Tb=\sum_{i=1}^3 a_ib_i=|a||b|cos(a,b) \\
外积：a\times b=
\left \| 
\begin{matrix} 
e_1 & e_2 & e_3 \\
a_1 & a_2 & a_3 \\
b_1 & b_2 & b_3
\end{matrix}
\right\| = 
\begin{bmatrix}
    a_2b_3-a_3b_2 \\ a_3b_1-a_1b_3\\ a_1b_2 - a_2b_1
  \end{bmatrix} =
\begin{bmatrix} 
0 & -a_3 & a_2 \\
a_3 & 0 & -a_1 \\
-a_2 & a_1 & 0
\end{bmatrix}b = a^\land b
$$

* 内积可以用来描述向量间的投影关系

* 外积的结果是一个向量，它的方向垂直于这两个向量，大小为 ab*sin(a, b)，是两个向量组成的四边形的面积

* 在外积公式中，我们将a写成一个矩阵，他是一个反对称矩阵（skew-symmetric matrix）。这个符号是一个一一映射，意味着任意向量都对应着唯一一个的反对称矩阵。



### 坐标系间的欧式变换

#### 惯性坐标系

世界坐标系，在一个系统中默认其为固定不动的

#### 刚体运动

* 旋转+平移

* 在刚体运动过程中，同一个向量在各个坐标系下的长度和夹角都不会发生变化
* 那么在发生刚性运动的前后，两个左边之间相差了一个欧式变换（Euclidean Transform）

#### 旋转

假设某个单位正交基（e1，e2，e3）经过一次旋转变成了（e1‘，e2’，e3‘）。那么对于同一个向量 a，因为这个向量本身并没有随着坐标系的旋转而运动，所以在新坐标系下的坐标就变为（a1‘，a2’，a3‘）。所以：
$$
\begin{bmatrix}
    e_1 & e_2 & e_3
  \end{bmatrix} 
  \begin{bmatrix}
  	a_1 \\ a_2 \\ a_3
  \end{bmatrix} = 
  \begin{bmatrix}
    e_1' & e_2' & e_3'
  \end{bmatrix} 
  \begin{bmatrix}
  	a_1' \\ a_2' \\ a_3'
  \end{bmatrix}
$$
这个公式可以进一步转化为：
$$
\begin{bmatrix}
  	a_1 \\ a_2 \\ a_3
  \end{bmatrix} = 
    \begin{bmatrix}
  	e_1^Te_1' & e_1^Te_2' & e_1^Te_3' \\ 
  	e_2^Te_1' & e_2^Te_2' & e_2^Te_3' \\
  	e_3^Te_1' & e_3^Te_2' & e_3^Te_3'
  \end{bmatrix}
    \begin{bmatrix}
  	a_1' \\ a_2' \\ a_3'
  \end{bmatrix} = Ra'
$$
这里中间3*3的矩阵也被称为旋转矩阵（Rotation Matrix）。因为基向量的长度都为1，所以这个矩阵也可以被称为方向余弦矩阵（Direction Cosine Matrix）

##### 旋转矩阵

​	这里旋转矩阵一般有这样的性质：(行列式为1的正交矩阵)
$$
RR^T=I, det(R)=1 \\
a'=R^{-1}a=R^Ta \\即 R^{-1}=R^T
$$

##### 特殊正交群（Special Orthogonal Group)

$$
SO(n)=\{ R\in R^{n\times n} | RR^T=1, det(R)=1 \}
$$

​	这里理解为从一维到n维的旋转矩阵的集合？比如SO(3)就是三维空间的旋转

#### 平移+旋转

$$
a'=Ra+t
$$

这里R是旋转矩阵，t是平移向量。

* R21：从1到2的旋转矩阵

  

### 变换矩阵与齐次坐标

​	上面欧氏空间的旋转与平移的变换关系不是一个线性关系，如果想让其变为线性，需要引入齐次坐标。即在三维向量的末尾加上1，使其变为四维向量。这个就是齐次坐标。对于这个四维向量，我们可以把旋转与平移写在一个矩阵中，使整个关系变成线性关系。这个 T 就是变换矩阵（Transform Matrix）
$$
\begin{bmatrix}
  	a' \\1
  \end{bmatrix} = 
  \begin{bmatrix}
  	R & t \\ 0^T & 1
  \end{bmatrix} 
  \begin{bmatrix}
  	a \\ 1
  \end{bmatrix} = T\begin{bmatrix}
  	a \\ 1
  \end{bmatrix}
$$
​	变换矩阵的结构为左上角为旋转矩阵，右侧为平移向量，左下角为0向量，右下角为1.

##### 特殊欧式群（Special Euclidean Group):

$$
SE(3)=\bigg\{ T=  \begin{bmatrix} R & t \\ 0^T & 1 \end{bmatrix} \in R^{4\times 4} | R\in SO(3), t\in R^3 \bigg\}
$$

跟SO(3)一样，这个矩阵的逆表示一个反向的变换：
$$
T^{-1}=  \begin{bmatrix}
  	R^T & -R^Tt \\ 0^T & 1
  \end{bmatrix} 
$$
我们发现一般 Ra 不需要齐次坐标，但是 Ta 需要齐次坐标，为了方便这里我们需要用到运算符重载



## 旋转向量和欧拉角

用矩阵来表示旋转和位移有这样的缺点：

1. SO(3)的旋转矩阵有9个量，但一次旋转只有三个自由度，同理变换矩阵有16个量但是表达的是6自由度的变换，所以用这样的表示方法很冗余。
2. 旋转矩阵和变换矩阵自身有约束：必须是正交矩阵而且行列式为1.

### 旋转向量

​	任何旋转都可以用一个旋转轴和一个旋转角来刻画，所以可以使用一个向量，其方向与旋转轴一致而长度等于旋转角。这样的话我们只需要一个三维向量来描述旋转，这就是**旋转向量（Axis-angle）**。对于变换矩阵，我们使用一个旋转向量加上一个平移向量来表达一次变换，这时正好是六维的变量。

​	这里我们假设旋转轴为一个单位长度的向量 n，角度为  \theta。那么向量 n*\theta可以用来描述这个旋转

#### 旋转向量与旋转矩阵的相互转换

##### 旋转向量 -> 旋转矩阵

$$
R=cos\theta I+(1-cos\theta)nn^T+sin\theta n^\land
$$

​	这里 ^ 代表了skew-symmetric transform

##### 旋转矩阵 -> 旋转向量

$$
\theta = arccos(\frac{tr(R)-1}{2}) \\
tr(R)=1+2cos\theta
$$

### 欧拉角

欧拉角上提供了一种直观的方式来描述旋转，它使用了三个分离的转角，把一个旋转分解成3次绕不同轴的旋转。因为有XYZ三个轴，而且轴可以是原始轴也可以旋转后的轴，所以欧拉角有很多种定义方式。

#### yaw-pitch-roll

yaw-pitch-roll是一种比较著名的欧拉角的方式，它等价于ZYX轴的旋转。

1. 绕物体的Z轴旋转，得到偏航角 yaw
2. 绕旋转之后的Y轴旋转，得到俯仰角 pitch
3. 绕旋转之后的X轴旋转，得到滚转角 roll

#### Gimbal Lock

​	Gimbal Lock（万向锁问题）是欧拉角的一个重大缺点。在上述例子中，如果俯仰角为 +-90度，第一次旋转和第三次旋转将使用同一个轴，这样系统就丢失了一个自由度。这就是**奇异性问题**

​	所以，欧拉角不适用于插值和迭代，也很少在SLAM中直接用欧拉角



## 四元数（Quaternion）

### 定义

​	四元数与复数类似，在二维情况下，旋转可以用单位复数来表示。那么在三维情况下，三维旋转可以用单位四元数来表示

​	一个四元数 q 拥有一个实部和三个虚部（i，j，k）：
$$
q=q_0+q_1i+q_2j+q_3k
$$
​	这三个虚部满足以下关系式：
$$
\begin{cases}
i^2=j^2=k^2=-1\\
ij=k, ji=-k \\
jk=i, kj=-i \\
ki=j, ik=-j
\end{cases}
$$
​	我们也可以用一个标量和一个向量来表示四元数：
$$
q=[s,v]^T, s=q_o\in R, v=[q_1, q_2, q_3]^T\in R
$$
​	在这里，s 为四元数的实部，v 是它的虚部。

* 如果一个四元数的虚部都为0，那么这是实四元数。如果它的实部是0，那么它是虚四元数。

### 四元数的运算

假设现在有两个四元数 qa，qb，他们可以这样表示：
$$
向量表示：[s_a,v_a]^T, [s_b, v_b]^T\\
原始四元数表示： q_a=s_a+x_ai+y_aj+z_ak, q_b=s_b+x_bi+y_bj+z_bk
$$

#### 加法和减法

$$
q_a +q_b=[s_a+s_b, v_a+v_b]^T
$$

#### 乘法

乘法是将qa的每一项都与qb的每一项相乘，最后相加，虚部按照 ijk 的关系进行化简
$$
q_aq_b=s_as_b-x_ax_b-y_ay_b-z_az_b\\
+(s_ax_b+x_as_b+y_az_b-z_ay_b)i \\
+(s_ay_b-x_az_b+y_as_b+z_ax_b)j \\
+(s_az_b+x_ay_b-y_ax_b+z_as_b)k \\
$$
写成向量形式并利用内外积运算会更简洁：
$$
q_aq_b=[s_as_b-v_a^Tv_b, s_av_b+v_a\times v_b]^T
$$

* 我们发现在该乘法定义下，两个实四元数的乘积仍为实。

* 因为最后一项外积（叉乘），四元数乘法时顺序不能改变

#### 模长

$$
||q_a||=\sqrt{s_a^2+x_a^2+y_a^2+z_a^2}
$$

同时我们发现两个四元数的乘积的模就是模的乘积，所以单位四元数相乘后仍为单位四元数
$$
||q_aq_b||=||q_a||\cdot||q_b||
$$

#### 共轭

四元数的共轭是将虚部取成相反数：
$$
q_a^*=s_a-x_ai-y_aj-z_ak=[s_a, \space -v_a]^T
$$
四元数共轭与其本身相乘，会得到一个实四元数，它的实部是模长的平方
$$
q^*q=qq^*=[s_a^2+v^Tv,\space 0]^T
$$

#### 逆

$$
q^{-1}=q^*/||q||^2
$$

四元数和自己的逆的乘积为实四元数1：
$$
qq^{-1}=q^{-1}q=1
$$
如果q是单位四元数，其逆和共轭就是同一个量。同时乘积的逆具有和矩阵相似的性质：
$$
(q_aq_b)^{-1}=q_b^{-1}q_a^{-1}
$$

#### 数乘

四元数与数字相乘：
$$
kq=[ks,\space kv]^T
$$


### 用四元数表示旋转

将三维空间点用一个虚四元数来描述
$$
p=[0,x,y,z]^T=[0,v]^T
$$
那么这时四元数的三个虚部与空间中的三个轴相对应，旋转后的 p' 就可以这样表示：
$$
p'=qpq^{-1}
$$
最后我们把 p' 的虚部取出，就得到了旋转之后的点的坐标。



### 四元数到其他旋转表示的转换

